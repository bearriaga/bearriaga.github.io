<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="icon" href="favicon.ico">
    <meta charset="utf-8" />
    <title>Initiative</title>

    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="Styles/app.css" />
</head>
<body>
    <div class="container-lg">

        <nav class="navbar navbar-expand-lg navbar-dark">
            <a class="navbar-brand" href="index.html">
                <img src="Pictures/MeFatterTransparent.png" width="30" height="30" alt="" loading="lazy">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="resume.html">Resume <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="contact.html">Contact <span class="sr-only">(current)</span></a>
                    </li>
                </ul>
            </div>
        </nav>

        <div>
            <form>
                <div class="form-group row">
                    <div class="col-3">
                        <label class="col-form-label">Add Party to Initiative Tracker</label>
                    </div>
                    <div class="col-3">
                        <select id="defaultPartyPicker" class="form-control"></select>
                    </div>
                    <div class="col-1">
                        <button type="button" id="addParty" class="btn btn-success form-control"><i class="bi bi-people-fill"></i></button>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-3">
                        <label class="col-form-label">Add Person to Initiative Tracker</label>
                    </div>
                    <div class="col-1">
                        <button type="button" id="addPerson" class="btn btn-success form-control"><i class="bi bi-person-plus-fill"></i></button>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-3">
                        <label class="col-form-label">Roll Initiative</label>
                    </div>
                    <div class="col-1">
                        <button type="button" id="rollInitiative" class="btn btn-primary form-control"><i class="bi bi-dice-6-fill"></i></button>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-3">
                        <label class="col-form-label">Sort Initiative</label>
                    </div>
                    <div class="col-1">
                        <button type="button" id="sortInitiative" class="btn btn-primary form-control"><i class="bi bi-sort-numeric-up-alt"></i></button>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-3">
                        <label class="col-form-label" title="This saves the current state of the Initiative Tracker as a cookie">Save Initiative <i class="bi bi-info-circle-fill"></i></label>
                    </div>
                    <div class="col-1">
                        <button type="button" id="saveInitiative" class="btn btn-primary form-control"><i class="bi bi-save-fill"></i></button>
                    </div>
                </div>
            </form>

            <h4>Initiative Tracker</h4>
            <div id="personLabels" class="form-row">
                <div class="col-3 text-center">
                    <label>Name</label>
                </div>
                <div class="col-2 text-center">
                    <label>Initiative Modifier</label>
                </div>
                <div class="col-2 text-center">
                    <label>Initiative</label>
                </div>
                <div class="col-2 text-center">
                    <label>Lock Initiative</label>
                </div>
                <div class="col-2 text-center">
                    <label>Remove Person</label>
                </div>
            </div>
            <form id="personContainer"></form>
            <div id="templateContainer" hidden>
                <div class="person form-group row">
                    <div class="col-3">
                        <input class="name form-control" type="text" placeholder="Name" value="{name}" />
                    </div>
                    <div class="col-2">
                        <input class="modifier form-control" type="number" placeholder="Modifier" value="{modifier}" />
                    </div>
                    <div class="col-2">
                        <input class="initiative form-control" type="number" placeholder="Initiative" value="{initiative}" />
                    </div>
                    <div class="col-2 form-check text-center">
                        <label class="col">
                            <input class="lock form-check-input" type="checkbox" {checked} />
                            <span><i class="bi bi-lock-fill"></i></span>
                        </label>
                    </div>
                    <div class="col-2 text-center">
                        <button class="removePerson btn btn-danger form-control" type="button"><i class="bi bi-person-dash-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var defaultParties = [
            {
                partyName: 'Friday Night',
                personArray: [
                    {
                        name: "Es'tonza Asadorna",
                        modifier: 2,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: 'Fleegan',
                        modifier: 4,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: 'Flimp',
                        modifier: 0,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: 'Grumph',
                        modifier: 2,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: 'Hugh Mynn',
                        modifier: 2,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: 'Zog Qiral',
                        modifier: 4,
                        initiative: 0,
                        lock: false
                    }
                ]
            },
            {
                partyName: 'Wednesday Night',
                personArray: [
                    {
                        name: "Anne 'Red' Bonny",
                        modifier: 4,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: "Estria/Nyx",
                        modifier: 3,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: "Urios Laughingstride",
                        modifier: 4,
                        initiative: 0,
                        lock: false
                    },
                    {
                        name: "Vinder Balam",
                        modifier: -3,
                        initiative: 0,
                        lock: false
                    }
                ]
            }
        ];
        var optionParties = [];
        var personArray = [];

        $(document).ready(() => {
            var personHtml = $('#templateContainer .person')[0].outerHTML;
            $('#personLabels').hide();

            function setPartyPickerOptions() {
                optionParties = [];
                if (cookieExists('initiative')) {
                    cookiePersonArray = JSON.parse(getCookie('initiative'));
                    var cookiePartyArray = [
                        {
                            partyName: 'Saved Initiative',
                            personArray: cookiePersonArray
                        }
                    ];
                    if (cookiePersonArray.length > 0)
                        optionParties = cookiePartyArray.concat(defaultParties);
                    else
                        optionParties = defaultParties;
                } else {
                    optionParties = defaultParties;
                }

                $('#defaultPartyPicker').html('')
                $(optionParties).each((i, obj) => {
                    $('#defaultPartyPicker').append('<option value="' + i + '">' + obj.partyName + '</option>');
                });
            }

            function getRandomInt(max) {
                return Math.floor(Math.random() * max) + 1;
            }

            function rollInitiative(modifier) {
                return getRandomInt(20) + parseInt(modifier);
            }

            function sortPersonArray() {
                personArray = personArray.sort(({ initiative: a }, { initiative: b }) => b - a);
            }

            function renderPersonArray() {
                $('#personContainer').html('');
                $(personArray).each(function (i) {
                    addPersonInputs(personArray[i]);
                });
            }

            function setPersonArray() {
                personArray = [];

                $('#personContainer .person').each(function (i, ele) {
                    var name = $(ele).find('.name').val();
                    var modifier = $(ele).find('.modifier').val();
                    var initiative = $(ele).find('.initiative').val();
                    var lock = $(ele).find('.lock').prop('checked');

                    var person =
                    {
                        name: (name) ? name : '',
                        modifier: (!isNaN(modifier)) ? modifier : '',
                        initiative: (!isNaN(initiative)) ? initiative : 0,
                        lock
                    };

                    personArray.push(person);
                });
            }

            function addPersonInputs(person) {
                $('#personLabels').show();
                if (person) {
                    $('#personContainer').append(
                        personHtml
                            .replace('{name}', person.name)
                            .replace('{modifier}', person.modifier)
                            .replace('{initiative}', person.initiative)
                            .replace('{checked}', (person.lock) ? 'checked' : '')
                    );
                } else {
                    $('#personContainer').append(
                        personHtml
                            .replace('{name}', '')
                            .replace('{modifier}', '')
                            .replace('{initiative}', '')
                            .replace('{checked}', '')
                    );
                }
            }

            function setCookie(cname, cvalue, exdays) {
                const d = new Date();
                d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
                let expires = "expires=" + d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }

            function getCookie(cname) {
                let name = cname + "=";
                let ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }

            function cookieExists(cname) {
                let cookie = getCookie(cname);
                return (cookie != '');
            }

            $('#addParty').click(() => {
                var position = $('#defaultPartyPicker').val();
                if (position) {
                    personArray = personArray.concat(optionParties[position].personArray);
                    $(optionParties[position].personArray).each((i, person) => {
                        addPersonInputs(person);
                    });
                }
            });

            $('#addPerson').click(() => {
                addPersonInputs(null);
            });

            $('#personContainer').on('click', '.removePerson', (e) => {
                $(e.target).closest('.person').remove();
                if ($('#personContainer .person').length == 0)
                    $('#personLabels').hide();
            });

            $('#rollInitiative').click(() => {
                setPersonArray();

                $(personArray).each((i, person) => {
                    person.initiative = (person.modifier && !person.lock) ? rollInitiative(person.modifier) : (!isNaN(person.initiative)) ? person.initiative : 0;
                });

                sortPersonArray();
                renderPersonArray();
            });

            $('#sortInitiative').click(() => {
                setPersonArray();
                sortPersonArray();
                renderPersonArray();
            });

            $('#saveInitiative').click(() => {
                setPersonArray();
                if (personArray.length > 0) {
                    setCookie('initiative', JSON.stringify(personArray), 30);
                    setPartyPickerOptions();
                } else {
                    alert('Initiative Tracker empty, nothing saved');
                }
            });

            setPartyPickerOptions();
        });
    </script>
</body>
</html>